<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Usuario</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#09CACD">

  <script src="https://unpkg.com/@webcomponents/webcomponentsjs@2.1.3/webcomponents-loader.js"></script>
  </script>
  <script defer src="/__/firebase/5.5.4/firebase-app.js"></script>
  <script defer src="/__/firebase/5.5.4/firebase-auth.js"></script>
  <script defer src="/__/firebase/5.5.4/firebase-database.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script type="module" src="js/herramientas-detalle.js"></script>
  <script type="module" src="js/campos-usuario.js"></script>
  <link rel="stylesheet" href="css/misestilos2.css">
  <link rel="shortcut icon" href="asd.ico" />
</head>

<body>
  <form class="vista" name="vista" action="javascript:;">
    <herramientas-detalle id="cabecera" regreso="index.html"></herramientas-detalle>
    <main role="main" class="blanc">
      <p>
        <label accesskey="U">
          Correo Electronico (ejp@gmail.com)
          <input name="cue" type="text" autofocus>
        </label>
      </p>
      <p>
        <label>
          Nombre
          <input type="text" name="nom" required="">
        </label>
      </p>
      <p>
        <label>
          direccion
          <input type="text" name="dire" required="">
        </label>
      </p>
      <p>
        <label>
          telefono
          <input type="text" name="tel" required="">
        </label>
      </p>  
      <select hidden  name="Rol" >
        <option selected value="Trabajador">Trabajador</option>
      </select> 
      <p hidden>
        <label>
          ids
          <input  type="text"  hidden name="ids" required="">
        </label>
      </p>  
    </main>
  </form>
  <script type="module">
    import { Util } from "./js/util.js";
    import { Dao } from "./js/dao.js";
    import { Navegacion } from "./js/navegacion.js";
    Util.registraServiceWorker();
    const locationRegreso = "index.html";
    const parametros = new URLSearchParams(location.search);
    const id = parametros.get("id");
    let roles;
    let cue;
    document.addEventListener('DOMContentLoaded', () => {
      Navegacion.sesionInicia(["Trabajador"]);
      if (WebComponents.ready) {
        carga();
      } else {
        document.addEventListener('WebComponentsReady', carga);
      }
    });
    function carga() {
      roles = document.getElementById("rol");
      window.usuarioListo.then(email => busca(email));


    }
    function busca(email) {
      Dao.buscaCampo("Trabajador", "upperCue", email.toUpperCase())
        .then(usuarios => {
          for (const modelo of usuarios) {
            document.vista.elimina
              .addEventListener("click", confirmaEliminar);
            document.vista.addEventListener("submit", guarda);
            cue = Util.texto(modelo.nom);
            document.title = cue;
            document.vista.ids.value = modelo.id;
            document.vista.cue.value = modelo.cue;
            document.vista.nom.value = modelo.nom;
            document.vista.dire.value = modelo.dire;
            document.vista.tel.value = modelo.tel;
            document.vista.titulo.value = cue;
          }
        })
      .catch(Util.muestraError);
    }
    function guarda() {
      try {
        const cue = document.vista.cue.value.trim();
        const ids = document.vista.ids.value.trim();
        const nom = document.vista.nom.value.trim();
        const dire = document.vista.dire.value.trim();
        const tel = document.vista.tel.value.trim();
        const Rol = document.vista.Rol.value.trim();
        const modelo = {
          id: ids,
          cue: cue,
          nom: nom,
          dire: dire,
          tel: tel,         
          rolIds: Util.getValores(document.vista.Rol),
          upperCue: cue.toUpperCase()
        };
        Dao.modifica("Trabajador", modelo)
          .then(regresaAVistaMaestra)
          .catch(Util.muestraError);
      } catch (e) {
        Util.muestraError(e)
      }
    }
    function confirmaEliminar() {
      if (confirm("Confirma la eliminación\nPerderás los datos.")) {
        Dao.elimina("Trabajador", id)
          .then(regresaAVistaMaestra)
          .catch(Util.muestraError);
      }
    }
    function regresaAVistaMaestra() {
      window.location = locationRegreso;
    }
  </script>
</body>
<footer id="pie">
  Derechos Reservados &copy; NIGTHWOLF TEC 2018
</footer>

</html>